<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soft-Res It</title>
    <link rel="stylesheet" href="/css/style.css">
    <script defer src="/js/index.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO" crossorigin="anonymous"></script>

</head>
<body>
    <%- include('partials/header.ejs') %>
    
   
    <%console.log(accountInfo !== undefined)%>
    <%console.log(accountInfo)%>

<div class="content-wrapper">
<div class="<%= accountInfo === undefined ? 'd-none' : 'user-div'%>" id="user-div">
    <div class="d-flex flex-column align-items-center gap-3 p-4 border rounded shadow-sm bg-light">
        <button id="new-user" class="btn btn-primary">Soft-Reserve or Join</button>
        <form action="/auth/sign-out" method="GET" class="d-flex justify-content-center w-100">
            <button type="submit" class="btn btn-outline-secondary">Log Out</button>
        </form>
    </div>
</div>

<div id="account-div" class="<%= accountInfo === undefined ? '' : 'd-none' %>">
    <div class="d-flex justify-content-center align-items-center gap-2 p-3 border rounded shadow-sm bg-light">
        <button id="sign-up" class="btn btn-success">Sign-Up</button>
        <span>or</span>
        <button id="sign-in" class="btn btn-primary">Sign-In</button>
    </div>
</div>
    
<form class="d-none" id="signIn-form" action="/auth/sign-in" method="POST">
    <div class="p-4 border rounded shadow-sm bg-light w-100" style="max-width: 400px; margin: auto;">
        <div class="mb-3">
            <label for="accountName" class="form-label">Account Name</label>
            <input type="text" name="accountName" id="accountName" class="form-control" required />
        </div>

        <div class="mb-3">
            <label for="password" class="form-label">Password</label>
            <input type="password" name="password" id="password" class="form-control" required />
        </div>

        <div class="d-flex justify-content-between">
            <button type="submit" class="btn btn-primary">Sign In</button>
            <button type="button" class="btn btn-outline-secondary cancel-acc-btn">Cancel</button>
        </div>
    </div>
</form>

<form class="d-none" id="signUp-form" action="/auth/sign-up" method="POST">
    <div class="p-4 border rounded shadow-sm bg-light w-100" style="max-width: 400px; margin: auto;">
        <div class="mb-3">
            <label for="accountName" class="form-label">Account Name</label>
            <input type="text" name="accountName" id="accountName" class="form-control" required />
        </div>
        <div class="mb-3">
            <label for="password" class="form-label">Password</label>
            <input type="password" name="password" id="password" class="form-control" required />
        </div>
        <div class="mb-3">
            <label for="confirmPassword" class="form-label">Confirm Password</label>
            <input type="password" name="confirmPassword" id="confirmPassword" class="form-control" required />
        </div>
        <div class="d-flex justify-content-between">
            <button type="submit" class="btn btn-success">Sign Up</button>
            <button type="button" class="btn btn-outline-secondary cancel-acc-btn">Cancel</button>
        </div>
    </div>
</form>

<form action="/createSR" method="POST" id="softres-form" class="d-none">
    <div class="p-4 border rounded shadow bg-light" style="max-width: 600px; margin: auto;">
        <h2 class="text-center mb-4">Soft-Reserve</h2>

        <div class="row mb-3">
            <div class="col-md-6 mb-3">
                <label for="username" class="form-label">Character Name</label>
                <input type="text" name="username" id="username" class="form-control" required>
            </div>
            <div class="col-md-6">
                <label for="note" class="form-label">Note</label>
                <input type="text" name="note" id="note" class="form-control">
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6 mb-3">
                <label for="class" class="form-label">Class</label>
                <select disabled name="class" id="class" class="form-select">
                    <option hidden selected value=""></option>
                    <option value="druid">Druid</option>
                    <option value="hunter">Hunter</option>
                    <option value="mage">Mage</option>
                    <option value="paladin">Paladin</option>
                    <option value="priest">Priest</option>
                    <option value="rogue">Rogue</option>
                    <option value="warlock">Warlock</option>
                    <option value="warrior">Warrior</option>
                </select>
            </div>

            <div class="col-md-6">
                <label for="spec" class="form-label">Specialization</label>
                <select disabled name="spec" id="spec" class="form-select">
                    <option hidden selected value=""></option>
                    <option class="druid spec" value="restoration">Restoration</option>
                    <option class="druid spec" value="bear">Bear</option>
                    <option class="druid spec" value="feral">Feral</option>
                    <option class="druid spec" value="balance">Balance</option>

                    <option class="hunter spec" value="marksmanship">Marksmanship</option>
                    <option class="hunter spec" value="beastmastery">Beast Mastery</option>
                    <option class="hunter spec" value="survival">Survival</option>

                    <option class="mage spec" value="frost">Frost</option>
                    <option class="mage spec" value="fire">Fire</option>
                    <option class="mage spec" value="arcane">Arcane</option>

                    <option class="paladin spec" value="protectionpala">Protection</option>
                    <option class="paladin spec" value="retribution">Retribution</option>
                    <option class="paladin spec" value="holypala">Holy</option>

                    <option class="priest spec" value="holy">Holy</option>
                    <option class="priest spec" value="discipline">Discipline</option>
                    <option class="priest spec" value="shadow">Shadow</option>

                    <option class="rogue spec" value="swords">Swords</option>
                    <option class="rogue spec" value="daggers">Daggers</option>
                    <option class="rogue spec" value="maces">Maces</option>

                    <option class="warlock spec" value="affliction">Affliction</option>
                    <option class="warlock spec" value="demonology">Demonology</option>
                    <option class="warlock spec" value="destruction">Destruction</option>

                    <option class="warrior spec" value="fury">Fury</option>
                    <option class="warrior spec" value="protection">Protection</option>
                    <option class="warrior spec" value="arms">Arms</option>
                </select>
            </div>
        </div>

        <div class="mb-4">
            <label for="softresd" class="form-label">Soft-Reserve: 0 of 2</label>
            <select disabled name="softresd" id="softresd" class="form-select">
                <option hidden selected value=""></option>
                <% for(item of items) { %>
                    <option class="item" value="<%=item._id%>"><%=item.name%></option>
                <% } %>
            </select>
        </div>

        <div class="d-flex justify-content-between">
            <button type="button" id="cancel-btn" class="btn btn-outline-secondary">Cancel</button>
            <button disabled type="submit" id="softres-form-button" class="btn btn-success">Soft-Reserve</button>
        </div>

        <input type="hidden" name="accountId" id="accountId" value="<% if (accountInfo !== undefined) { %><%= accountInfo._id %><% } %>" />
    </div>
</form>

   <table class="table table-bordered table-hover table-striped align-middle">
    <thead class="table-dark text-center">
        <tr>
            <th scope="col">Username</th>
            <th scope="col">Class</th>
            <th scope="col">Items</th>
            <th scope="col">Functions</th>
        </tr>
    </thead>
    <tbody>
        <% if (users.length === 0) { %>
            <tr>
                <td colspan="4" class="text-center text-muted">No Soft Reserves</td>
            </tr>
        <% } %>

        <% for (user of users) { %>
            <tr id="<%= user._id %>">
                <td>
                    <div class="fw-semibold"><%= user.username %></div>
                    <% if (user.note) { %>
                        <small class="text-muted"><%= user.note %></small>
                    <% } %>
                </td>
                <td class="text-capitalize"><%= user.class %></td>
                <td>
                    <%= user.softresd[0] %><br>
                    <%= user.softresd[1] %>
                </td>
                <td>
                    <% if (accountInfo !== undefined && accountInfo._id === user.accountId) { %>
                        <div class="d-flex gap-2">
                            <form action="/users/<%= user._id %>/edit" method="GET">
                                <button type="submit" class="btn btn-sm btn-outline-primary">Edit</button>
                            </form>
                            <form action="/users/<%= user._id %>?_method=DELETE" method="POST">
                                <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                            </form>
                        </div>
                    <% } %>
                </td>
            </tr>
        <% } %>
    </tbody>
</table>

<table class="table table-bordered table-hover table-striped align-middle">
    <thead class="table-dark text-center">
        <tr>
            <th>Name</th>
            <th>Slot</th>
            <th>ilvl</th>                  
            <th>From</th>
            <th>Soft-reservers</th>
        </tr>
    </thead>
    <tbody>
        <% for (item of items) { 
            const reserverCount = item.softresdby.length;
            let reserverClass = 'softres-0';
            if (reserverCount === 1) reserverClass = 'softres-1';
            else if (reserverCount === 2) reserverClass = 'softres-2';
            else if (reserverCount === 3) reserverClass = 'softres-3';
            else if (reserverCount >= 4) reserverClass = 'softres-4';
        %>
            <tr id="<%= item._id %>">
                <td class="fw-semibold"><%= item.name %></td>
                <td class="text-capitalize"><%= item.slot %></td>
                <td><%= item.ilvl %></td>
                <td><%= item.from %></td>
                <td class="<%= reserverClass %>">
                    <% for (user of item.softresdby) { %>
                        <span class="badge bg-secondary me-1"><%= user %></span>
                    <% } %>
                </td>
            </tr>
        <% } %>
    </tbody>
</table>
</div>
</body>
</html>